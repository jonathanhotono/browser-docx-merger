var DocxMerger;
import H from"jszip";var i={w:"http://schemas.openxmlformats.org/wordprocessingml/2006/main",r:"http://schemas.openxmlformats.org/officeDocument/2006/relationships",pr:"http://schemas.openxmlformats.org/package/2006/relationships"},g={document:"word/document.xml",docRels:"word/_rels/document.xml.rels",numbering:"word/numbering.xml",styles:"word/styles.xml",footnotes:"word/footnotes.xml",endnotes:"word/endnotes.xml",fontTable:"word/fontTable.xml",theme:"word/theme/theme1.xml",webSettings:"word/webSettings.xml",settings:"word/settings.xml",ct:"[Content_Types].xml"};async function G(t,n={}){let e=wt(n),r=(c,y="info")=>e.onLog?.(c,y);if(t.length<2)throw new Error("Need at least two DOCX sources");if(!e.pattern&&!e.insertStart&&!e.insertEnd)throw new Error("Provide a pattern or set insertStart/insertEnd");r?.(`Reading ${t.length} DOCX files ...`);let s=await Promise.all(t.map(c=>yt(c))),a=await Promise.all(s.map(c=>H.loadAsync(c))),o=a[0],f=await T(o,g.document),m=await N(o,g.docRels,I()),u=await T(o,g.ct),d=j(m),b=dt(u),p=F(f),h=q(p);h&&p.removeChild(h);let S=0+(e.insertStart?1:0)+(e.insertEnd?1:0);if(e.insertStart)for(let c=1;c<a.length;c++)await O(o,a[c],f,m,d,b,e,!1);if(e.pattern){let c=pt(f,e.pattern);if(c.length===0)r?.("Pattern not found in base document","warn");else{let y=c[0];for(let A=1;A<a.length;A++)await K(o,a[A],f,m,d,b,y,e);S+=1}}if(e.insertEnd)for(let c=1;c<a.length;c++)await O(o,a[c],f,m,d,b,e,!0);if(S===0)throw new Error("No insertion was performed (nothing to do).");h&&p.appendChild(h),await v(o,g.document,f),await v(o,g.docRels,m),await v(o,g.ct,u),r?.("Packaging merged .docx ...");let l=await o.generateAsync({type:"arraybuffer"}),w=new Blob([l],{type:"application/vnd.openxmlformats-officedocument.wordprocessingml.document"});return r?.("Done."),w}async function bt(t,n={}){return G(t,n)}async function K(t,n,e,r,s,a,o,f){let{importedNodes:m}=await W(t,n,e,r,s,a,f),u=o.parentNode;for(let d of m)u.insertBefore(d,o)}async function O(t,n,e,r,s,a,o,f){let m=F(e),{importedNodes:u}=await W(t,n,e,r,s,a,o);o.pageBreaks&&m.lastChild&&m.appendChild(rt(e));for(let d of u)m.appendChild(d)}async function W(t,n,e,r,s,a,o){let f=await T(n,g.document),m=F(f),u=q(m);u&&m.removeChild(u);let d=await N(n,g.docRels,I()),b=new Map,p=new Map;o.mergeNumbering&&({numIdMap:b,absIdMap:p}=await Q(t,n,e),V(m,b)),o.mergeStyles&&(await X(t,n),await Z(r,s)),o.mergeFootnotes&&(await J(t,n,"footnotes"),await J(t,n,"endnotes"),_(m,await P(t,n,"footnotes")),_(m,await P(t,n,"endnotes")));let h=[];for(let S of Array.from(m.childNodes)){if(S.nodeType!==1)continue;let l=e.importNode(S,!0),w=[l,...at(l)];for(let c of w)if(c.nodeType===1)for(let y of Array.from(c.attributes||[])){if(!(y.localName==="id"&&y.namespaceURI===i.r||y.name==="r:id"))continue;let C=y.value,x=await tt(C,d,r,n,t,s,a);x?c.setAttributeNS(i.r,"r:id",x):c.removeAttributeNS(i.r,"id")}h.push(l)}return{importedNodes:h}}async function Q(t,n,e){let r=await N(t,g.numbering,U()),s=await N(n,g.numbering,U()),a=r.documentElement,o=s.documentElement,f=new Set(Array.from(a.getElementsByTagNameNS(i.w,"abstractNum")).map(l=>+(l.getAttributeNS(i.w,"abstractNumId")||l.getAttribute("w:abstractNumId")||l.getAttribute("w:abstractNumId")||"0"))),m=new Set(Array.from(a.getElementsByTagNameNS(i.w,"num")).map(l=>+(l.getAttributeNS(i.w,"numId")||l.getAttribute("w:numId")||l.getAttribute("w:numId")||"0"))),u=Math.max(0,...Array.from(f.values())),d=Math.max(0,...Array.from(m.values())),b=()=>++u,p=()=>++d,h=new Map,S=new Map;for(let l of Array.from(o.getElementsByTagNameNS(i.w,"abstractNum"))){let w=+(l.getAttributeNS(i.w,"abstractNumId")||l.getAttribute("w:abstractNumId")||l.getAttribute("abstractNumId")||"0"),c=b();h.set(w,c),l.setAttributeNS(i.w,"w:abstractNumId",String(c)),a.appendChild(r.importNode(l,!0))}for(let l of Array.from(o.getElementsByTagNameNS(i.w,"num"))){let w=+(l.getAttributeNS(i.w,"numId")||l.getAttribute("w:numId")||l.getAttribute("numId")||"0"),c=p();S.set(w,c),l.setAttributeNS(i.w,"w:numId",String(c));let y=l.getElementsByTagNameNS(i.w,"abstractNumId")[0];if(y){let A=+(y.getAttributeNS(i.w,"val")||y.getAttribute("w:val")||y.getAttribute("val")||"0"),C=h.get(A)??A;y.setAttributeNS(i.w,"w:val",String(C))}a.appendChild(r.importNode(l,!0))}return await v(t,g.numbering,r),{numIdMap:S,absIdMap:h}}function V(t,n){let e=t.getElementsByTagNameNS(i.w,"p");for(let r of Array.from(e)){let s=r.getElementsByTagNameNS(i.w,"numPr")[0];if(!s)continue;let a=s.getElementsByTagNameNS(i.w,"numId")[0];if(!a)continue;let o=+(a.getAttributeNS(i.w,"val")||a.getAttribute("w:val")||a.getAttribute("val")||"NaN");Number.isFinite(o)&&n.has(o)&&a.setAttributeNS(i.w,"w:val",String(n.get(o)))}}async function X(t,n){let e=await N(t,g.styles,$()),r=await N(n,g.styles,$()),s=new Set(Array.from(e.getElementsByTagNameNS(i.w,"style")).map(a=>a.getAttributeNS(i.w,"styleId")||a.getAttribute("w:styleId")||a.getAttribute("styleId")));for(let a of Array.from(r.getElementsByTagNameNS(i.w,"style"))){let o=a.getAttributeNS(i.w,"styleId")||a.getAttribute("w:styleId")||a.getAttribute("styleId");o&&!s.has(o)&&(e.documentElement.appendChild(e.importNode(a,!0)),s.add(o))}await v(t,g.styles,e),await B(t,n,g.fontTable,it(),"font"),await B(t,n,g.theme,lt(),null),await B(t,n,g.webSettings,ct(),null),await Y(t,n)}async function B(t,n,e,r,s){let a=n.file(e);if(a){if(s){let o=await N(t,e,r),f=await T(n,e),m=new Set(Array.from(o.getElementsByTagNameNS(i.w,s)).map(u=>u.getAttributeNS(i.w,"name")||u.getAttribute("w:name")||u.getAttribute("name")||""));for(let u of Array.from(f.getElementsByTagNameNS(i.w,s))){let d=u.getAttributeNS(i.w,"name")||u.getAttribute("w:name")||u.getAttribute("name");d&&!m.has(d)&&(o.documentElement.appendChild(o.importNode(u,!0)),m.add(d))}await v(t,e,o)}else if(!t.file(e)){let o=await a.async("uint8array");t.file(e,o)}}}async function Y(t,n){if(!n.file(g.settings))return;let r=await N(t,g.settings,mt()),s=await T(n,g.settings),a=["defaultTabStop","characterSpacingControl","printTwoOnOne","printColorBlackWhite","doNotPromptForConvert","mwSmallCaps"];for(let o of a){let f=s.getElementsByTagNameNS(i.w,o)[0];f&&!r.getElementsByTagNameNS(i.w,o)[0]&&r.documentElement.appendChild(r.importNode(f,!0))}await v(t,g.settings,r)}async function Z(t,n){let e=[{path:g.styles,type:"http://schemas.openxmlformats.org/officeDocument/2006/relationships/styles"},{path:g.fontTable,type:"http://schemas.openxmlformats.org/officeDocument/2006/relationships/fontTable"},{path:g.theme,type:"http://schemas.openxmlformats.org/officeDocument/2006/relationships/theme"},{path:g.webSettings,type:"http://schemas.openxmlformats.org/officeDocument/2006/relationships/webSettings"},{path:g.settings,type:"http://schemas.openxmlformats.org/officeDocument/2006/relationships/settings"}];for(let r of e){let s=L(g.document,r.path);k(t,r.type,s)||E(t,n(),r.type,s)}}async function J(t,n,e){let r=e==="footnotes"?g.footnotes:g.endnotes,s="word/_rels/"+(e==="footnotes"?"footnotes.xml.rels":"endnotes.xml.rels"),a=e==="footnotes"?ot():st(),o=await N(t,r,a),f=await N(n,r,a),m=e==="footnotes"?"footnote":"endnote",u=Array.from(o.getElementsByTagNameNS(i.w,m)).map(l=>+(l.getAttributeNS(i.w,"id")||l.getAttribute("w:id")||l.getAttribute("id")||"0")),d=Math.max(0,...u.filter(l=>l>=0)),b=new Map;for(let l of Array.from(f.getElementsByTagNameNS(i.w,m))){let w=+(l.getAttributeNS(i.w,"id")||l.getAttribute("w:id")||l.getAttribute("id")||"0");if(w<0){b.set(w,w);continue}let c=++d;b.set(w,c),l.setAttributeNS(i.w,"w:id",String(c)),o.documentElement.appendChild(o.importNode(l,!0))}t.__noteMap=t.__noteMap||{},t.__noteMap[e]=b;let p=await N(t,s,I()),h=await N(n,s,I()),S=j(p);for(let l of Array.from(h.getElementsByTagNameNS(i.pr,"Relationship"))){let w=l.getAttribute("Type"),c=l.getAttribute("Target"),y=l.getAttribute("TargetMode")||"";if(k(p,w,c,y||void 0))continue;let C=S();if(E(p,C,w,c,y||void 0),!y){let x=R(r,c),M=await n.file(x)?.async("uint8array");M&&t.file(z(t,x),M)}}await v(t,r,o),await v(t,s,p)}async function P(t,n,e){return t.__noteMap&&t.__noteMap[e]?t.__noteMap[e]:new Map}function _(t,n){if(!(!n||n.size===0))for(let e of["footnoteReference","endnoteReference"]){let r=t.getElementsByTagNameNS(i.w,e);for(let s of Array.from(r)){let a=+(s.getAttributeNS(i.w,"id")||s.getAttribute("w:id")||s.getAttribute("id")||"NaN");n.has(a)&&s.setAttributeNS(i.w,"w:id",String(n.get(a)))}}}async function tt(t,n,e,r,s,a,o){if(!t)return null;let f=et(n,t);if(!f)return null;let m=f.getAttribute("Type"),u=f.getAttribute("Target"),d=f.getAttribute("TargetMode")||void 0,b=k(e,m,u,d);if(b)return b.getAttribute("Id");let p=a();if(m.endsWith("/hyperlink"))return E(e,p,m,u,d||"External"),p;if(m.endsWith("/image")){let l=R(g.document,u),w=ft(l),c=r.file(w);if(c){let y=await c.async("uint8array"),{name:A,ext:C}=gt(w),x=ut(s,A,C);o(C),s.file(x,y);let M=L(g.document,x);return E(e,p,m,M,d),p}return E(e,p,m,u,d),p}let h=R(g.document,u),S=r.file(h);if(S){let l=await S.async("uint8array"),w=z(s,h);s.file(w,l);let c=L(g.document,w);return E(e,p,m,c,d),p}return E(e,p,m,u,d),p}function et(t,n){let e=t.getElementsByTagNameNS(i.pr,"Relationship");for(let r of Array.from(e))if(r.getAttribute("Id")===n)return r;return null}function k(t,n,e,r){let s=t.getElementsByTagNameNS(i.pr,"Relationship");for(let a of Array.from(s))if(a.getAttribute("Type")===n&&a.getAttribute("Target")===e&&(a.getAttribute("TargetMode")||"")===(r||""))return a;return null}function E(t,n,e,r,s){let a=t.documentElement,o=t.createElementNS(i.pr,"Relationship");o.setAttribute("Id",n),o.setAttribute("Type",e),o.setAttribute("Target",r),s&&o.setAttribute("TargetMode",s),a.appendChild(o)}async function T(t,n){let e=t.file(n);if(!e)throw new Error("Missing "+n);let r=await e.async("text");return D(r)}async function N(t,n,e){let r=t.file(n);if(!r)return D(e);let s=await r.async("text");return D(s)}async function v(t,n,e){t.file(n,nt(e))}function D(t){let n=new DOMParser().parseFromString(t,"application/xml"),e=n.querySelector("parsererror");if(e)throw new Error("XML parse error: "+(e.textContent||"unknown"));return n}function nt(t){return new XMLSerializer().serializeToString(t)}function F(t){return t.getElementsByTagNameNS(i.w,"body")[0]}function q(t){let n=t?t.getElementsByTagNameNS(i.w,"sectPr"):[];return n&&n.length?n[n.length-1]:null}function at(t){let n=[],e=document.createTreeWalker(t,NodeFilter.SHOW_ELEMENT,null);for(;e.nextNode();)n.push(e.currentNode);return n}function rt(t){let n=t.createElementNS(i.w,"w:p"),e=t.createElementNS(i.w,"w:r"),r=t.createElementNS(i.w,"w:br");return r.setAttributeNS(i.w,"w:type","page"),e.appendChild(r),n.appendChild(e),n}function I(){return`<?xml version="1.0" encoding="UTF-8" standalone="yes"?><Relationships xmlns="${i.pr}"></Relationships>`}function U(){return`<?xml version="1.0" encoding="UTF-8" standalone="yes"?><w:numbering xmlns:w="${i.w}"></w:numbering>`}function $(){return`<?xml version="1.0" encoding="UTF-8" standalone="yes"?><w:styles xmlns:w="${i.w}"></w:styles>`}function ot(){return`<?xml version="1.0" encoding="UTF-8" standalone="yes"?><w:footnotes xmlns:w="${i.w}"></w:footnotes>`}function st(){return`<?xml version="1.0" encoding="UTF-8" standalone="yes"?><w:endnotes xmlns:w="${i.w}"></w:endnotes>`}function it(){return`<?xml version="1.0" encoding="UTF-8" standalone="yes"?><w:fonts xmlns:w="${i.w}"></w:fonts>`}function lt(){return'<?xml version="1.0" encoding="UTF-8" standalone="yes"?><a:theme xmlns:a="http://schemas.openxmlformats.org/drawingml/2006/main" name="Office Theme"><a:themeElements><a:clrScheme name="Office"><a:dk1><a:sysClr val="windowText" lastClr="000000"/></a:dk1><a:lt1><a:sysClr val="window" lastClr="FFFFFF"/></a:lt1><a:dk2><a:srgbClr val="44546A"/></a:dk2><a:lt2><a:srgbClr val="E7E6E6"/></a:lt2><a:accent1><a:srgbClr val="4472C4"/></a:accent1><a:accent2><a:srgbClr val="E15759"/></a:accent2><a:accent3><a:srgbClr val="70AD47"/></a:accent3><a:accent4><a:srgbClr val="FFC000"/></a:accent4><a:accent5><a:srgbClr val="5B9BD5"/></a:accent5><a:accent6><a:srgbClr val="843C0C"/></a:accent6><a:hlink><a:srgbClr val="0563C1"/></a:hlink><a:folHlink><a:srgbClr val="954F72"/></a:folHlink></a:clrScheme><a:fontScheme name="Office"><a:majorFont><a:latin typeface="Calibri Light" panose="020F0302020204030204"/><a:ea typeface=""/><a:cs typeface=""/></a:majorFont><a:minorFont><a:latin typeface="Calibri" panose="020F0502020204030204"/><a:ea typeface=""/><a:cs typeface=""/></a:minorFont></a:fontScheme><a:fmtScheme name="Office"><a:fillStyleLst><a:solidFill><a:schemeClr val="phClr"/></a:solidFill><a:gradFill rotWithShape="1"><a:gsLst><a:gs pos="0"><a:schemeClr val="phClr"><a:lumMod val="110000"/><a:satMod val="105000"/><a:tint val="67000"/></a:schemeClr></a:gs><a:gs pos="50000"><a:schemeClr val="phClr"><a:lumMod val="105000"/><a:satMod val="103000"/><a:tint val="73000"/></a:schemeClr></a:gs><a:gs pos="100000"><a:schemeClr val="phClr"><a:lumMod val="105000"/><a:satMod val="109000"/><a:tint val="81000"/></a:schemeClr></a:gs></a:gsLst><a:lin ang="5400000" scaled="0"/></a:gradFill><a:gradFill rotWithShape="1"><a:gsLst><a:gs pos="0"><a:schemeClr val="phClr"><a:satMod val="103000"/><a:lumMod val="102000"/><a:tint val="94000"/></a:schemeClr></a:gs><a:gs pos="50000"><a:schemeClr val="phClr"><a:satMod val="110000"/><a:lumMod val="100000"/><a:shade val="100000"/></a:schemeClr></a:gs><a:gs pos="100000"><a:schemeClr val="phClr"><a:lumMod val="99000"/><a:satMod val="120000"/><a:shade val="78000"/></a:schemeClr></a:gs></a:gsLst><a:lin ang="5400000" scaled="0"/></a:gradFill></a:fillStyleLst><a:lnStyleLst><a:ln w="6350" cap="flat" cmpd="sng" algn="ctr"><a:solidFill><a:schemeClr val="phClr"/></a:solidFill><a:prstDash val="solid"/><a:miter lim="800000"/></a:ln><a:ln w="12700" cap="flat" cmpd="sng" algn="ctr"><a:solidFill><a:schemeClr val="phClr"/></a:solidFill><a:prstDash val="solid"/><a:miter lim="800000"/></a:ln><a:ln w="19050" cap="flat" cmpd="sng" algn="ctr"><a:solidFill><a:schemeClr val="phClr"/></a:solidFill><a:prstDash val="solid"/><a:miter lim="800000"/></a:ln></a:lnStyleLst><a:effectStyleLst><a:effectStyle><a:effectLst/></a:effectStyle><a:effectStyle><a:effectLst/></a:effectStyle><a:effectStyle><a:effectLst><a:outerShdw blurRad="57150" dist="19050" dir="5400000" algn="ctr" rotWithShape="0"><a:srgbClr val="000000"><a:alpha val="63000"/></a:srgbClr></a:outerShdw></a:effectLst></a:effectStyle></a:effectStyleLst><a:bgFillStyleLst><a:solidFill><a:schemeClr val="phClr"/></a:solidFill><a:solidFill><a:schemeClr val="phClr"><a:tint val="95000"/><a:satMod val="170000"/></a:schemeClr></a:solidFill><a:gradFill rotWithShape="1"><a:gsLst><a:gs pos="0"><a:schemeClr val="phClr"><a:tint val="93000"/><a:satMod val="150000"/><a:shade val="98000"/><a:lumMod val="102000"/></a:schemeClr></a:gs><a:gs pos="50000"><a:schemeClr val="phClr"><a:tint val="98000"/><a:satMod val="130000"/><a:shade val="90000"/><a:lumMod val="103000"/></a:schemeClr></a:gs><a:gs pos="100000"><a:schemeClr val="phClr"><a:shade val="63000"/><a:satMod val="120000"/></a:schemeClr></a:gs></a:gsLst><a:lin ang="5400000" scaled="0"/></a:gradFill></a:bgFillStyleLst></a:fmtScheme></a:themeElements></a:theme>'}function ct(){return`<?xml version="1.0" encoding="UTF-8" standalone="yes"?><w:webSettings xmlns:w="${i.w}"></w:webSettings>`}function mt(){return`<?xml version="1.0" encoding="UTF-8" standalone="yes"?><w:settings xmlns:w="${i.w}"></w:settings>`}function j(t){return function(){let n=t.getElementsByTagNameNS(i.pr,"Relationship"),e=0;for(let r of Array.from(n)){let s=/rId(\d+)/.exec(r.getAttribute("Id")||"");s&&(e=Math.max(e,+s[1]))}return"rId"+(e+1)}}function gt(t){let n=t.lastIndexOf("."),e=n>=0?t.substring(n+1).toLowerCase():"";return{name:n>=0?t.substring(0,n):t,ext:e}}function ut(t,n,e){let r="word/media/",s=n.substring(n.lastIndexOf("/")+1).replace(/[^A-Za-z0-9_\-]/g,"_"),a=1,o;do o=`${r}merged_${s}_${a}.${e}`,a++;while(t.file(o));return o}function z(t,n){let e=n.lastIndexOf("."),r=e>=0?n.substring(e):"",s=e>=0?n.substring(0,e):n,a=1,o;do o=`${s}_merged_${a}${r}`,a++;while(t.file(o));return o}function R(t,n){let r=(t.substring(0,t.lastIndexOf("/")+1)+n).split("/"),s=[];for(let a of r)if(a==="..")s.pop();else{if(a==="."||a==="")continue;s.push(a)}return s.join("/")}function ft(t){if(t.startsWith("word/media/"))return t;let n=t.indexOf("word/");if(n>=0){let e=t.substring(n+5);if(e.startsWith("media/"))return"word/"+e}return t}function L(t,n){let e=t.substring(0,t.lastIndexOf("/")+1);return n.startsWith(e)?n.substring(e.length):n}function dt(t){return function(e){let r=t.getElementsByTagName("Default");for(let o of Array.from(r))if((o.getAttribute("Extension")||"").toLowerCase()===e.toLowerCase())return;let s={bmp:"image/bmp",gif:"image/gif",jpg:"image/jpeg",jpeg:"image/jpeg",png:"image/png",tif:"image/tiff",tiff:"image/tiff",emf:"image/x-emf",wmf:"image/x-wmf"},a=t.createElement("Default");a.setAttribute("Extension",e),a.setAttribute("ContentType",s[e]||"application/octet-stream"),t.documentElement.appendChild(a)}}function pt(t,n){let e=F(t),r=Array.from(e.getElementsByTagNameNS(i.w,"p")),s=[];for(let a of r){let o="",f=a.getElementsByTagNameNS(i.w,"t");for(let m of Array.from(f))o+=m.textContent||"";o.includes(n)&&s.push(a)}return s}function St(t,n){let e=document.createElement("a");e.href=t,e.download=n,document.body.appendChild(e),e.click(),e.remove(),setTimeout(()=>URL.revokeObjectURL(t),1500)}function wt(t){return{pattern:t.pattern??null,insertStart:!!t.insertStart,insertEnd:!!t.insertEnd,pageBreaks:t.pageBreaks!==!1,mergeNumbering:t.mergeNumbering!==!1,mergeStyles:t.mergeStyles!==!1,mergeFootnotes:t.mergeFootnotes!==!1,onLog:t.onLog}}async function yt(t){if(t instanceof Uint8Array)return t;if(t instanceof Blob){let n=t,e=typeof n.arrayBuffer=="function"?await n.arrayBuffer():await new Response(t).arrayBuffer();return new Uint8Array(e)}return new Uint8Array(t)}export{G as mergeDocx,bt as mergeDocxFromFiles,St as triggerDownload};
